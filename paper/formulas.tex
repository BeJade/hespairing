\section{Computation of line functions}
\label{sec:formulas}

%XXX To Chloe: is this still correct? wouldn't everything collapse to 1?
%XXX don't forget to put reference
We now move to the explicit computation of the line functions
$\ell_{1} = L_{P,Q}$ and $\ell_{2} = L_{P,-P}$
given in the formula for the reduced Tate pairing.
Recall from \ref{?} that the denominator of the reduced Tate pairing was given by	%XXX add ref here
\[L_{nP,-nP}(Q)^{\frac{p^{k}-1}{r}},\]
where $P \in E(\FF_{p})$ and $Q \in E(\FF_{p^{k}})$.
Recall also from \ref{?} that, possibly replacing $E$ by a twist,			%XXX add ref here
we may assume without loss of generality that $Q \in E(\FF_{p^{k/3}})$.
Write $nP = (x_{nP},y_{nP},z_{nP})$ and $Q=(x_{Q},y_{Q},z_{Q})$.
Then applying the group law we compute the equation of $L_{nP,-nP}$ to be
\[Y + Z + (y_{nP} + z_{nP})X = 0,\] which evaluated at $Q$ gives an element $b$ of $\FF_{p^{k/3}}$.
Now observe that
\[(p^{k} -1) = (p^{k/3}-1)(\sum_{i=0}^{2k/3} p^{i}),\]
and by minimality of the embedding degree that $r \not | p^{k/3}-1$,
hence
\[L_{nP,-nP}(Q)^{\frac{p^{k}-1}{r}} = b^{\frac{p^{k}-1}{r}} = (b^{p^{k/3}-1})^\frac{\sum_{i=0}^{2k/3} p^{i}}{r} = 1.\]
So this does not contribute to the reduced Tate pairing.
%%%%%%%%%%%%%%%%%%%%

The heart of pairings lies on the computation of line functions.
A rational function $f_{r,P}$ associated to the point $P$ and some integer $r$
is first constructed.
Then, this function is evaluated at the point $Q$.
The divisor associated to the function $f_{,P}$ is
$$ div(f_{r,P}) = r(P) - (rP) - (r-1)(P_\infty). $$
Miller's algorithm computes $f_{r,P}$ in the double-and-add manner
and uses the following relation
$$ f_{i+j,P} = f_{i,P} f_{j,P} \frac{l_1}{l_2}, $$
where $l_1$ is a line through $iP$ and $jP$,
and $l_2$ is a line through $(i+j)P$ and $-(i+j)P$.

Constructing the line $l_1$ can be done by substituting $x$ and $y$ coordinates of points $iP$ and $jP$
into an equation $y = mx + b$ and solving for $m$ and $b$.
For Weierstrass curves, the line $l_2$ is simply a vertical line through $(i+j)P$.
Therefor, the line $l_2$ is of the form $x = c$ where $c$ is the $x$-coordinate of the point $(i+j)P$.
Note that the point $(i+j)P$ and $-(i+j)P$ have the same $x$-coordinate.
However, for Hessian curves, the line $l_2$ is not a vertical line
and thus has to be constructed in a similar way as the line $l_1$,
i.e., solving for $m$ and $b$ of $y = mx + b$ using points $(i+j)P$ and $-(i+j)P$.

%Let $m = (m_{\ell-1}, \dots, m_1, m_0)$ be the binary representation of $m$.
%Initialize $R = P$ and $f = 1$.
%Algorithm~\ref{algo:miller} shows Miller's algorithm.
%%\renewcommand{\algorithmicrequire}{\textbf{Initialize:}}
%%\renewcommand{\algorithmicensure}{\textbf{Output:}}
%\begin{algorithm}
%\caption{Miller's algorithm}
%\label{algo:miller}
%\begin{algorithmic}[1]
%
%%	\Require $R = P$ and $f = 1$
%
%	\For {$i := \ell - 2$ {\bf{down to}} $0$}
%		\State $f \leftarrow f^2 \cdot f_{DBL(R)}(Q)$
%		\State $R \leftarrow 2R$
%		\If {$m_i = 1$}
%			\State $f \leftarrow f \cdot f_{ADD(R,P)}(Q)$
%			\State $R \leftarrow R+P$
%		\EndIf
%	\EndFor
%	\State $f \leftarrow f^{(p^k-1)/r}$
%
%\end{algorithmic}
%\end{algorithm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Denominator elimination}
We follow a similar technique as described in~\cite{2008/lin} and~\cite{2009/deg15}
by rewriting an inversion into a fraction having denominator lies in a subfield.
Define a finite field extension $\F{p^k}$ of a finite field $\F{p}$
and elements $x,y \in \F{p^k}$.

Observe that
$$ \frac{1}{x-y} = \frac{x^2 + xy + y^2}{x^3 - y^3}. $$
Because $x^3$ and $y^3$ lie in a subfield of $\F{p^k}$ and so as $x^3 - y^3$,
the final exponentiation forces $x^3 - y^3$ to become 1.
This means that we can ignore the computation of the denominator $x^3 - y^3$.
Therefore, instead of computing $\frac{1}{x-y}$,
we compute $x^2 + xy + y^2$
and the cost of division by $x - y$ beceomes the cost of multiplication by $x^2 + xy + y^2$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Explicit formulas}

Recall the twsited Hessian curve equation in projective coordiates
%$ a x^3 + y^3 = 1 + d x y, $ or
$$ \mathcal{H}: a X^3 + Y^3 = Z^3 + d X Y Z. $$
This subsection shows formulas to compute point doubling, point addition, and line functions associated to these operations.
These formulas work under an assumption that the curve parameter $d = 0$.

Symbols $\mul, \sqr, \mulp{a}, k, d$ denote
field multiplication,
field squaring,
field multiplication by curve constant $a$,
embedding degree and
twist degree respectively.

\subsubsection{Doubling.}
%	// 5M + 2S + 3*3 + 1*2 + 1*neg + 6*add
%	// assume d = 0
Given a point $P = (X_1,Y_1,Z_1)$ on $E/\F{p}$ and a point $Q = (X_Q,Y_Q,1)$ on $E/\F{p^{k}}$
where $X_Q \in \F{p^{k}}$ and $Y_Q \in \F{p^{k/d}}$,
the following formulas compute the doubling of point $P = 2P = (X_3,Y_3,Z_3)$ and the line function $l$.
\begin{align*}
T &= Y_1^2;\	\qquad	A = Y_1 \cdot T;\	\qquad
S = Z_1 ^ 2;\	\qquad	B = Z_1 \cdot S;\\
X_3 &= X_1 \cdot (A - B);\	\quad
Y_3 = -Z_1 \cdot (2A + B);\	\quad
Z_3 = Y_1 \cdot (A + 2B);\\
l_1 &= a X_1^2 X_Q + T \cdot Y_Q + S;\	\qquad
l_a = X_3 \cdot Y_Q + X_3;	\\
l_b &= X_Q \cdot (Y_3 + Z_3);\			\qquad
%l_c = (l_a^2 + l_a \cdot l_b + l_b^2);\		\qquad
l_c = l_a^2 + l_b \cdot (l_a + l_b);\		\qquad
l = l_1 \cdot l_c;
\end{align*}
The total number of operations is
%$ k(2\mul + \frac{2}{3}\sqr) + 5\mul +3\sqr + 1\mul_a$ for {\it{odd}} embedding degrees.
$ k(\frac{14}{3}\mul + \frac{1}{3}\sqr) + 5\mul +3\sqr + 1\mul_a$.
%Note that curves generated by our Construction 1 have even embedding degrees.
%The total number of operations for {\it{even}} embedding degrees is
%$ \frac{4}{3}k\mul + 5\mul +3\sqr + 1\mul_a$.

\subsubsection{Addition.}
Given points $P = (X_1,Y_1,1)$ and $R = (X_2,Y_2,Z_2)$ on $E/\F{p}$ and a point $Q = (X_Q,Y_Q,1)$ on $E/\F{p^{k}}$
where $X_Q \in \F{p^{k}}$ and $Y_Q \in \F{p^{k/d}}$,
the following formulas compute the addition of points $P + R = (X_1,Y_1,Z_1) + (X_2,Y_2,Z_2) = (X_3,Y_3,Z_3)$ and the line function $l$.
\begin{align*}
A &= X_1 \cdot Z_2;\	\qquad
C = Y_1 \cdot X_2;\	\qquad
D = Y_1 \cdot Y_2;\	\qquad
F = a X_1 \cdot X_2;\\
G &= (D + Z_2) \cdot (A - C);\	\quad
H = (D - Z_2) \cdot (A + C);\\
J &= (D + F) \cdot (A - Y_2);\	\quad
K = (D - F) \cdot (A + Y_2);\\
X_3 &= G - H;\	\qquad
Y_3 = K - J;\\
Z_3 &= J + K - G - H - 2(B - F) \cdot (C + E);\\
l_1 &= (Y_1 \cdot Z_2 - Y_2) \cdot (X_1 - X_Q) + (Y_Q - Y_1) \cdot (X_1 \cdot Z_2 - X_2);\\
l_a &= Y_Q \cdot X_3 + X_3;\	\quad
l_b = X_Q \cdot (Y_3 + Z_3);\	\quad
%l_c = (l_a^2 + l_a \cdot l_b + l_b^2);\\
l_c = l_a^2 + l_a \cdot (l_b + l_b);\\
l &= l_1 \cdot \l_c;
\end{align*}
The total number of operations is
$ k(\frac{14}{3}\mul + \frac{1}{3}\sqr) + 11\mul + 1\mul_a$.
%$ \frac{4}{3}k\mul + 11\mul + 1\mul_a$ for {\it{even}} embedding degrees.


