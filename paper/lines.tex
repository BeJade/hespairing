\section{Computation of line functions}
\label{sec:lines}

The efficiency of pairings relies heavily on the computation of the line functions
(as denoted by $\ell_{2R} = l_{R,R}/v_{2R}$ and $\ell_{R,P} = l_{R,P}/v_{R+P}$ in Algorithm~\ref{algo:miller}).
Recall that $l_{R,P}$ is notation for the line passing through $R$ and $P$ and that
$v_{T}$ is notation for the line passing through $T$ and $-T$.
In many other representations of elliptic curves, for example short Weierstrass form,
Edwards form, and Jacobi Quartic form, the negation of a point is its reflection in the $x$-axis
due to the fact that the identity group element is the point at infinity.
In paritcular, the line $v_T$ has a particularly simple form, meaning that very often
the field inversion can be avoided using demoninator elimination techniques.

For curves in Hessian form, the neutral group element is given by $[-1:0:1]$,
and negation by
\[-(x,y) = (x/y,1/y)\]
(in affine coordinates).
Below, we give an optimized algorithm to compute the line functions for
Hessian curves 
\[\mathcal{H}/\F{q}: aX^3 + Y^3 + Z^3 = 0\]
of $j$-invariant 0 
for pairings on both $\G{1} \times \G{2}$ (such as the Tate pairing)
and $\G{2} \times \G{1}$ (such as the ate pairing).
We restrict to $j$-invariant 0 in order to make use of the degree 3 twist that
is then available to us:

Let
$$ \mathcal{H}_{\omega}: a \omega^3 X^3 + Y^3 + Z^3 = 0, $$
where $\omega \in \F{q^k} $ generates $\F{q^k}$ as a $\F{q^{k/3}}$-vector space.
Then $\mathcal{H}_{\omega}$ is a degree 3 twist of $\mathcal{H}$; the two curves are isomorphic via
\begin{equation}\label{twistiso}
\begin{array}{rccc}
\varphi: & \mathcal{H}_{\omega} & \rightarrow & \mathcal{H} \\
& [X:Y:Z] & \mapsto & [\omega X:Y:Z].
\end{array}
\end{equation}
In particular, if $R' \in \mathcal{H}_{\omega}(\F{q^{k/3}})$, then
$\varphi(R') \in \G{2}$.
Analogously to \cite{??}, we choose the $\G{2}$ input point for the pairing
from $\varphi(\mathcal{H}_{\omega}(\F{q^{k/3}})$.
This allows is to do many calculations in $\F{q^{k/3}}$ instead of $\F{q^k}$,
as explained in detail on a case-by-case basis below.

\subsection{Arithmetic on Hessian curves}

For the benefit of the reader, we include the most efficient (known) formulas
for doubling and adding points on elliptic curves in Hessian form.

Let $R = (X_1, Y_1, Z_1) \in \mathcal{H}(k)$, 
and denote by $\mul$ and $\sqr$ 
the time required to perform a multiplication and squaring in $k$ respectively.
The following formulas compute $2R = (X_3,Y_3,Z_3)$:
\begin{align*}
T &= Y_1^2;\	\qquad	A = Y_1 \cdot T;\	\qquad
S = Z_1 ^ 2;\	\qquad	B = Z_1 \cdot S;\\
X_3 &= X_1 \cdot (A - B);\	\quad
Y_3 = -Z_1 \cdot (2A + B);\	\quad
Z_3 = Y_1 \cdot (A + 2B).
\end{align*}
The cost for point doubling with the above formulas is $5\mul + 2\sqr$. 

Let $P = (X_1,Y_1,1)$ and $R = (X_2,Y_2,Z_2) \in \mathcal{H}(k)$.
The following formulas compute
$P + R = (X_1,Y_1,1) + (X_2,Y_2,Z_2) = (X_3,Y_3,Z_3)$:
\begin{align*}
A &= X_1 \cdot Z_2;\	\qquad
C = Y_1 \cdot X_2;\	\qquad
D = Y_1 \cdot Y_2;\	\qquad
F = \eta \cdot X_2;\\
G &= (D + Z_2) \cdot (A - C);\	\quad
H = (D - Z_2) \cdot (A + C);\\
J &= (D + F) \cdot (A - Y_2);\	\quad
K = (D - F) \cdot (A + Y_2);\\
X_3 &= G - H;\	\qquad
Y_3 = K - J;\\
Z_3 &= J + K - G - H - 2(Z_2 - F) \cdot (C + Y_2),
\end{align*}
where $\eta = a\cdot X_1$ can be precomputed.
The cost for point addition with the above formulas is $9\mul$.

\subsection{Even embedding degrees with pairings on $\G{1} \times \G{2}$}

Recall that Miller's algorithm computes the line function 
$$\ell_{P_1,P_2}(Q) = l_{P_1,P_2}(Q)/v_{P_1 + P_2}(Q);$$
for pairings on $\G{1} \times \G{2}$ we have that $P_1, P_2 \in \G{1}$ and $Q \in \G{2}$.

To avoid the field inversion we apply the denominator elimination technique of \cite{GGX10},
described briefly below. 
It is shown in \cite[Section 4]{GGX10} that if
$\alpha \in \F{q^k} \setminus \F{q^{k/2}}$, then
without loss of generality we may assume that a point
$Q \in E(\F{q^k})$ is of the form
$Q = (c+d\alpha, c-d\alpha )$, where
$c, d \in \F{q^{k/2}}$.
In particular, the line $v_R$ passing through $R = (x,y) \in E(\F{q})$ 
and $-R = (x/y, 1/y)$ evaluated at $Q$ is given by
$2c(y-x) + x^2-y^2 \in \F{q^{k/2}}$.
Hence in the final exponentiation step of Miller's algorithm the denominator will become 1,
therefore can be ignored.

So, we replace the line funtion $\ell_{P_1,P_2}(Q)$ by just $l_{P_1,P_2}(Q)$.
When $P_1 = P_2 = R$, this is the tangent line at $R$ evaluated at $Q$, which is given by
\[l_{R,R}(Q): aX_1^2 X_Q + T Y_Q + S.\]
where $R = [X_1:Y_1:Z_1]$ 
and $S$ and $T$ are the values that were computed in the point doubling computation.
Set $Q' = [X_{Q'}:Y_{Q'}:1]$ and $Q = \varphi(Q')$, where
$\varphi$ is the twist isomorphism \eqref{twistiso}.
Then we can write $l_{R,R}(Q)$ as

\[l_{R,R}(Q): (S Y_{Q'} + T) + aX_1^2 X_{Q'} \omega.\]

In particular, computing this line function by computing its coefficients as an element of the $\F{q^{k/3}}$-vector space
generated by $\omega$ amounts to $\sqr$ to compute $U = X_1^2$ plus two multiplications of an $\F{p}$-element
with an $\F{q^{k/3}}$-element in order to compute $S Y_Q'$ and $U \eta'$, 
where $\eta = aX_Q'$ (which can be precomputed). 
Each of these multiplications
costs $k/3\mul$ with schoolbook vector-space multiplication.
Furthermore, a general element of $\F{q^k}$ considered as element of the $\F{q^{k/3}}$-vector space generated
by $\omega$ will be of the form 
\[c_1 \omega + c_2 \omega^2 + c_3 \omega^3,\]
but for $l_{2R}(Q)$ we have that $c_2 = 0$. In particular, the multiplication of $l_{2R}(Q)$ with $f^2$ in
Step 3 of Algorithm~\ref{alg:miller} will not be the full cost of a general multiplication in $\F{q^k}$ (that
is, approximately $k^2\mul$), but by schoolbook multiplication will cost 6 multiplications in $\F{q^{k/3}}$, which
amounts to $6 (k/3)^2 \mul = 2/3 \Mul$.
Putting together all of the above, the entire Miller doubling costs
\[(5\mul + 2\sqr) + \left(1\sqr + \frac{2k}{3}\mul\right) + \frac{2}{3}\Mul  + 1\Sqr 
= \left( 5 + \frac{2k}{3}\right)\mul + 3\sqr + \frac{2}{3}\Mul + 1\Sqr.\]

When $P_1  = P = [X_1:Y_1:1]$ and $P_2 = R = [X_2:Y_2:Z_2]$, 
the line $l_{P_1,P_2}(Q)$ is the line passing through $P$ and $R$ evaluated at $Q$.
As above we write $Q = [\omega X_Q':Y_Q':1]$ so that
$$l_{P,R}(Q): (E - Y_2) \cdot X_1 + (Y_{Q'} - Y_1) \cdot (A - X_2) - (E - Y_2) \cdot X_{Q'}\omega,  $$
where $E = Y_1 \cdot Z_2$, and where $A$ is the value that was computed during the computation of $P+R$.
In particular, computing this line function by computing its coefficients as an element of the $\F{q^{k/3}}$-vector space
generated by $\omega$ amounts to $2\mul$ to compute $E$ and $(E-Y_2)\cdot X_1$ plus 
two multiplications of an $\F{p}$-element with an $\F{q^{k/3}}$-element in order to compute 
$(Y_{Q'} - Y_1) \cdot (A - X_2)$ and $(E - Y_2) \cdot X_{Q'}$. Each of these multiplications costs $k/3\mul$
with schoolbook vector-space multiplication.
Also exactly as for the the doubling line function, multiplying a general element of $\F{q^k}$ with $l_{P,R}(Q)$ costs only
$2/3\Mul$.
Putting together all of the above, the entire Miller addition step costs
\[9\mul + \left(2\mul + \frac{2k}{3}\mul\right) + \frac{2}{3}\Mul 
= \left(11 + \frac{2k}{3}\right)\mul + \frac{2}{3}\Mul.\]

\subsection{Odd embedding degrees with pairings on $\G{1} \times \G{2}$}

Unfortunately the denominator elimination technique of \cite{GGX10} does not apply to this case;
instead we extend ideas of~\cite{2008/lin} and~\cite{2009/deg15}.
Write $[X_3:Y_3:Z_3] = P_1 + P_2$ and $[X_Q:Y_Q:1] = Q$. 
Recall that Miller's algorithm starts from a chosen point $Q \in \G{2}$;
as above we use the twist isomorphism \eqref{twistiso} to write
$Q = [X_{Q'}\omega:Y_{Q'}:1]$, where $X_{Q'}$ and $Y_{Q'} \in \F{q^{k/3}}$.
The line $v_{P_1+P_2}(Q)$ passing through $P_1+P_2$ and $-(P_1 + P_2)$ 
evaluated at $Q$
is hence given by
\[v_{P_1+P_2}(Q): 
(Z_3 + Y_3)X_{Q'}\omega - (1+Y_Q')X_3.\]
To avoid inversion, we simply apply a trick of~\cite{2008/lin} and~\cite{2009/deg15}, 
namely observing that
\[\frac{1}{x-y} = \frac{x^2 + xy + y^2}{x^3-y^3}.\]
Plugging in $x = (Z_3 + Y_3)X_{Q'}\omega$ and $y = (1+Y_{Q'})X_3$ in $\frac{1}{v_{P_1+P_2}(Q)}$,
we get that the denominator $x^3 - y^3$ is in $\F{q^{k/3}}$ so will disappear in the final exponentiation, hence can be ignored.
So we replace $\frac{1}{v_{P_1+P_2}(Q)}$ by the numerator 
$$n_{P_1+P_2}(Q) = ((Z_3 + Y_3)X_{Q'})^2\omega^2 
+ (Z_3 + Y_3)X_{Q'}(1+Y_{Q'})X_3\omega 
+ ((1+Y_{Q'})X_3)^2.$$

That is, we replace the line funtion $\ell_{P_1,P_2}(Q)$ by $n_{P_1,P_2}(Q) \cdot l_{P_1,P_2}(Q)$.
As for even embedding degrees, the computation of $l_{P_1,P_2}(Q)$ costs $\sqr + \frac{2k}{3}\mul$ if $P_1 = P_2$ and $2\mul + \frac{2k}{3}\mul$ if $P_1 \neq P_2$. 
The computation of $n = n_{P_1+P_2}(Q)$ can be computed in
$\frac{2k}{3}\mul + \frac{2}{9}\Sqr + \frac{1}{9}\Mul$ via
\[\begin{array}{cccc}
An = (Z_3 + Y_3)\cdot X_{Q'}; &
Bn = (1+Y_{Q'})X_3; &
n = An^2\cdot\omega^2 + An\cdot Bn\omega + Bn^2,
\end{array}\]
and the multiplication of $n_{P_1+P_2}(Q)$ with $l_{P_1,P_2}(Q)$ costs $\frac{2}{3}\Mul$ 
as $l_{P_1+P_2}(Q)$ has no coefficient of $\omega^2$.

Putting the above together, the full Miller doubling step costs
\[(5\mul + 2\sqr) + \left(\sqr + \frac{4k}{3}\mul + \frac{2}{9}\Sqr + \frac{7}{9}\Mul\right)  + 1\Sqr + 1\Mul\
=3\sqr + \left(5 + \frac{4k}{3}\right)\mul + \frac{11}{9}\Sqr + \frac{16}{9}\Mul,\]
and the full Miller addition step costs 
\[9\mul + \left( \left(2+\frac{4k}{3}\right)\mul + \frac{2}{9}\Sqr + \frac{7}{9}\Mul\right) + 1\Mul
=\left( 11+\frac{4k}{3}\right)\mul + \frac{2}{9}\Sqr + \frac{16}{9}\Mul.\]

\subsection{Pairings on $\G{2} \times \G{1}$}

Recall that Miller's algorithm computes the line function 
$$\ell_{P_1,P_2}(Q) = l_{P_1,P_2}(Q)/v_{P_1 + P_2}(Q);$$
for pairings on $\G{2} \times \G{1}$ we have that $P_1, P_2 \in \G{2}$ and $Q \in \G{1}$.

Unfortunately the denominator elimination technique of \cite{GGX10} does not apply to this case;
instead we extend ideas of~\cite{2008/lin} and~\cite{2009/deg15}.
Write $[X_3:Y_3:Z_3] = P_1 + P_2$ and $[X_Q:Y_Q:1] = Q$. 
Recall that Miller's algorithm starts from a chosen point $P \in \G{2}$
from which $P_1$ and $P_2$ are derived - in particular $P_1 + P_2$
multiple of $P$, say $mP$.
Using the twist isomorphism \eqref{twistiso} we can assume that
$P$ is the image of a point $P' \in \mathcal{H}_{\omega}(\F{q^{k/3}})$,
so that $P_1 + P_2 = mP$ is given by $\varphi(mP')$.
It follows that there exist $X_3', Y_3',Z_3' \in \F{q^{k/3}}$ such that
$P_1 + P_2 = [X_3'\omega : Y_3':Z_3']$. 
The line $v_{P_1+P_2}(Q)$ passing through $P_1+P_2$ and $-(P_1 + P_2)$ 
evaluated at $Q$
is hence given by
\[v_{P_1+P_2}(Q): 
(Z_3' + Y_3')X_Q - (1+Y_Q)X_3'\omega.\]
To avoid inversion, we simply apply a trick of~\cite{2008/lin} and~\cite{2009/deg15}, 
namely observing that
\[\frac{1}{x-y} = \frac{x^2 + xy + y^2}{x^3-y^3}.\]
Plugging in $x = (Z_3' + Y_3')X_Q$ and $y = (1+Y_Q)X_3'\omega$ in $\frac{1}{v_{P_1+P_2}(Q)}$,
we get that the denominator $x^3 - y^3$ is in $\F{q^{k/3}}$ so will disappear in the final exponentiation, hence can be ignored.
So we replace $\frac{1}{v_{P_1+P_2}(Q)}$ by the numerator 
$$n_{P_1+P_2}(Q) = ((Z_3' + Y_3')X_Q)^2 
+ (Z_3' + Y_3')X_Q(1+Y_Q)X_3'\omega 
+ ((1+Y_Q)X_3')^2\omega^2.$$

That is, we replace the line funtion $\ell_{P_1,P_2}(Q)$ by $n_{P_1,P_2}(Q) \cdot l_{P_1,P_2}(Q)$.
When $P_1 = P_2 = R$, the line $l_{P_1,P_2}(Q)$ is the tangent line at $R$ evaluated at $Q$, which is given by
\[l_{R,R}(Q): aX_1'^2 X_Q \omega^2 + T Y_Q + S.\]
where $S$ and $T$ are the values that were computed in the point doubling computation - note that
both values lie in $\F{q^{k/3}}$.
We compute $\ell_{R,R}(Q)$ in 
$\frac{1}{3}\Sqr + \frac{7}{9}\Mul + \frac{4k}{3}\mul$ as follows:
\[\begin{array}{cccc}
A = (1+Y_Q)X_3';&
 B = X_Q(Z_3' + Y_3'); &
 C = X_1'^2; &
 D = C\eta;
\end{array}\]
\[\begin{array}{ccc}
n = B^2 + AB \omega + A^2 \omega^2; &
l = S + TY_Q + D\omega^2; &
\ell_{R,R}(Q) = nl,
\end{array}\]
where $\eta = aX_Q$ is precomputed.
Observe further that when computing $2R$ we can instead compute
$\varphi(2\varphi^{-1}(R))$ due to the simplicity of the twist isomorphism \eqref{twistiso},
so that our operation count for point doubling occurs in $\F{q^{k/3}}$, not $\F{q^k}$, giving a total cost of $\frac{5}{9}\Mul + \frac{2}{9}\Sqr$ for the computation of $2R$.
Putting together the above, we get a total cost of 
\[\left(\frac{5}{9}\Mul + \frac{2}{9}\Sqr\right) + \left(\frac{1}{3}\Sqr + \frac{7}{9}\Mul + \frac{4k}{3}\mul \right) + \Mul + \Sqr = \frac{7}{3}\Mul + \frac{14}{9}\Sqr + \frac{4k}{3}\mul\]
for the whole Miller doubling step.

When $P_1  = P = [X_1:Y_1:1]$ and $P_2 = R = [X_2:Y_2:Z_2]$, 
the line $l_{P_1,P_2}(Q)$ is the line passing through $P$ and $R$ evaluated at $Q$.
As above we write $P = [\omega X_1':Y_1':1]$ and 
$R = [\omega X_2': Y_2', Z_2']$ where $X_1',Y_1',X_2',Y_2',Z_2' \in \F{q^{k/3}}$ 
so that
$$l_{P,R}(Q): - (E - Y_2') \cdot X_{Q} + ((E - Y_2') \cdot X_1' + (Y_{Q}-Y_1')(A'-X_2'))\omega, $$
where $E = Y_1' \cdot Z_2'$, and where $A = A'\omega = X_1'Z_2'\omega$ is the value that was computed during the computation of $P+R$.
We compute $\ell_{P,R}(Q)$ in
$k\mul + \Mul + \frac{2}{9}\Sqr$
as follows:
\[\begin{array}{ccc}
A = (1+Y_Q)X_3';&
 B = X_Q(Z_3' + Y_3'); &
 C = (E-Y_2')X_Q;
\end{array}\]
\[\begin{array}{cc}
 D = (E-Y_2')X_1'; &
  F = (Y_Q-Y_1')(A'-X_2');
\end{array}\]
\[\begin{array}{ccc}
n = B^2 + AB \omega + A^2 \omega^2; &
l = -C + (D+F)\omega; &
\ell_{R,R}(Q) = nl.
\end{array}\]

Observe further that when computing $P+R$ we can instead compute
$\varphi(\varphi^{-1}(P) + \varphi^{-1}(R))$ due to the simplicity of the twist isomorphism \eqref{twistiso},
so that our operation count for point addition occurs in $\F{q^{k/3}}$, not $\F{q^k}$, that is,
point addition costs $9(\frac{k}{3})^2\mul = \Mul$.

Putting the together above, we see that the whole Miller addition step takes

\[\Mul + \left( k\mul + \Mul + \frac{2}{9}\Sqr \right) + \Mul = 3\Mul + \frac{2}{9}\Sqr + k\mul.\]

